% clear;clc;
tiny = 1E-6;

%def0

% Vdef = transpose([...
% 1.574516	-0.589552	-4.534427	1.206328	1.236374	-0.192710	-0.329819	-0.102067	-0.680745	0.042505	0.124852	-0.072712	0.487086	0.368846
% 1.471086	-0.558360	-4.437065	1.165700	1.188204	-0.176864	-0.302865	-0.095693	-0.643582	0.044592	0.119633	-0.072733	0.475586	0.357986
% 1.370935	-0.541315	-4.325260	1.132868	1.142709	-0.161692	-0.277560	-0.090340	-0.610870	0.048702	0.116695	-0.077481	0.462267	0.348263
% 1.287377	-0.504508	-4.242309	1.092935	1.098680	-0.148710	-0.252317	-0.082454	-0.576217	0.050055	0.117563	-0.086212	0.450655	0.332448
% 1.200901	-0.485836	-4.137721	1.061083	1.057742	-0.136193	-0.230392	-0.076939	-0.547394	0.053761	0.114379	-0.089797	0.438440	0.322226
% 1.117094	-0.467621	-4.033279	1.030452	1.019366	-0.124382	-0.210675	-0.071825	-0.519936	0.057105	0.111054	-0.092184	0.427124	0.312390
% 1.037574	-0.450210	-3.930042	1.001063	0.983100	-0.113239	-0.192349	-0.066997	-0.494023	0.060205	0.107645	-0.094028	0.416420	0.302704
% 0.962224	-0.433730	-3.826822	0.972735	0.948751	-0.102795	-0.175338	-0.062607	-0.469418	0.062874	0.104075	-0.095309	0.406398	0.293242
% 0.891549	-0.418988	-3.725601	0.946115	0.916031	-0.092812	-0.159480	-0.058664	-0.446225	0.065402	0.100498	-0.096262	0.396809	0.284057
% 0.824069	-0.402891	-3.627702	0.919142	0.885387	-0.083334	-0.144632	-0.055200	-0.423830	0.066789	0.096546	-0.096352	0.388312	0.274946]);
% Vdef = transpose([...
% 1.253652	-0.510978	-4.249264	1.089797	1.097103	-0.157676	-0.271004	-0.086613	-0.577170	0.036473	0.112609	-0.070282	0.451498	0.341243
% 1.230329	-0.506303	-4.201153	1.081089	1.083117	-0.150904	-0.258497	-0.084445	-0.567654	0.042021	0.111693	-0.073100	0.447113	0.337765
% 1.210975	-0.495935	-4.172521	1.069891	1.069202	-0.144262	-0.245995	-0.081509	-0.555334	0.045311	0.112351	-0.077969	0.443105	0.331360
% 1.184088	-0.493909	-4.132488	1.063237	1.056461	-0.138306	-0.235711	-0.079223	-0.545743	0.050259	0.111715	-0.080762	0.438513	0.327586
% 1.156643	-0.490310	-4.094520	1.056906	1.044502	-0.133111	-0.226395	-0.076922	-0.536141	0.054651	0.111058	-0.083663	0.434047	0.323688
% 1.131719	-0.484939	-4.061898	1.050268	1.032952	-0.128414	-0.217594	-0.074582	-0.526173	0.058105	0.109930	-0.085894	0.429723	0.319344
% 1.100673	-0.484999	-4.038134	1.044388	1.022101	-0.124214	-0.210270	-0.072353	-0.515954	0.061083	0.108678	-0.087056	0.425578	0.315042
% 1.072301	-0.481428	-4.013072	1.038370	1.011948	-0.120776	-0.203776	-0.070304	-0.505579	0.063349	0.107332	-0.088016	0.421739	0.310550
% 1.049702	-0.468809	-3.979095	1.032003	1.002542	-0.118184	-0.197664	-0.068432	-0.495569	0.064968	0.106184	-0.089146	0.418484	0.305589
% 1.031233	-0.453245	-3.945041	1.025463	0.993681	-0.115722	-0.192123	-0.066603	-0.485112	0.066076	0.104799	-0.090023	0.415259	0.300617]);
Vdef = transpose([...																
1.141979	-0.360471	-4.087112	0.998928	1.054105	-0.128383	-0.220588	-0.069237	-0.519286	0.016980	0.096248	-0.072688	0.450484	0.323637
1.147846	-0.399791	-4.079601	1.017516	1.049255	-0.128680	-0.221745	-0.072043	-0.523540	0.029814	0.100437	-0.076209	0.443993	0.323606
1.154639	-0.428823	-4.073666	1.031553	1.044843	-0.129374	-0.222335	-0.073807	-0.527404	0.040458	0.104142	-0.079788	0.438873	0.323331
1.153654	-0.452248	-4.074553	1.040367	1.041794	-0.130191	-0.222468	-0.074719	-0.530524	0.048102	0.107128	-0.082869	0.435633	0.322841
1.153858	-0.465045	-4.074243	1.045322	1.039835	-0.130548	-0.222161	-0.074915	-0.532600	0.052704	0.109268	-0.085413	0.433970	0.322437
1.157425	-0.466512	-4.075198	1.046250	1.038563	-0.130554	-0.221429	-0.074332	-0.533312	0.053771	0.110154	-0.086740	0.434002	0.322011
1.164060	-0.457097	-4.075892	1.043754	1.037983	-0.130182	-0.220521	-0.072969	-0.532907	0.051760	0.110029	-0.086949	0.435573	0.321745
1.170160	-0.441531	-4.077177	1.038458	1.038074	-0.129821	-0.219310	-0.071049	-0.532119	0.047190	0.109321	-0.087074	0.438400	0.321732
1.172799	-0.424264	-4.080968	1.030311	1.038856	-0.128802	-0.217605	-0.068784	-0.530678	0.040327	0.108096	-0.087066	0.442406	0.321959
1.175417	-0.395535	-4.085078	1.016294	1.041058	-0.127323	-0.215155	-0.066219	-0.528516	0.030252	0.106284	-0.086528	0.448321	0.321918]);

%
shell_mask = [1:100];
% set kpoint
kstart=[
    0.000000   0.000000   0.000000
    0.000000   0.500000   0.500000
    0.000000   0.000000   0.000000
    ]';
kend=[
    1.000000   0.500000   0.500000
    0.000000   0.000000   0.000000
    0.500000   0.500000   0.500000
    ]';
klabel={'G','X','G','L'};

% load tb.pg.sym
tb=xml_read('../save.tb');
pg.sym=reshape(str2num(tb.group.sym.value),tb.group.sym.shape);

% load primitive 
[pc] = load_poscar('../POSCAR');

% create kpoint path
[bz] = get_kpoint_path(pc.bas*pc.latpar,kstart,kend,40);

k=0;
for i = 1:bz.npaths
for j = 1:bz.ndivs
    k=k+1;
    H = get_H_numeric_cart(pg, Vdef(:,10), bz.path(i).kpt_cart(:,j),shell_mask);
%     H = get_H_numeric_cart(pg, mean(Vdef(:,5:6),2), bz.path(i).kpt_cart(:,j),shell_mask);
    if (abs(norm(H-H'))>tiny) 
        fprintf('H is not hermitian\n')
        return
    end
    bz.path(i).D(:,j) = sort(real(eig(H)));
end
end
% y0=transpose([bz.path(:).D]);
% y0=y0(:);
%
figure(1); set(gcf,'color','white'); hold on;
y = transpose([bz.path(:).D]);
x = [];
for i = 1:size(y,2)
x = [x,[bz.path.x]];
end
x=x';
size(x)
y=y(:);
% plot(x,y)
%
z = zeros(size(x));
col = (y-y0)./0.05;  % This is the color, vary with x in this case.
surface([x,x],[y0(:),y0(:)],[z,z],[col,col],...
        'facecol','no',...
        'edgecol','interp',...
        'linew',3);
colorbar
% plot(x,y,'r');
axis tight;
colormap('parula')
% get ticks
ticks(1) = 0;
for i = 1:bz.npaths
    ticks(i+1) = bz.path(i).x(end);
end
set(gca,'XTick',ticks);
set(gca,'Xticklabel',klabel);
ylabel('Energy [eV]')
xlabel('k')
box on
%%
h=line([0,max([bz.path(:).x])],[0,0]);
set(h,'color',[0.1 0.1 0.1],'linewidth',2,'LineStyle',':');

set(gca,'LooseInset',get(gca,'TightInset'))
set(gcf,'PaperSize',[10 10])
set(gcf,'PaperPosition',[0 0, 1.61803398875,1]*3)
print(gcf,'-depsc','band')
